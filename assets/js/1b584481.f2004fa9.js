"use strict";(self.webpackChunkaggregation_pipeline_workshop=self.webpackChunkaggregation_pipeline_workshop||[]).push([[7348],{5415:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>s,metadata:()=>u,toc:()=>d});var r=t(4848),o=t(8453),a=t(1470),i=t(9365);const s={},l="\ud83e\uddb8\u200d\u2642\ufe0f Writing Long Pipelines",u={id:"simple-queries/writing-long-pipelines",title:"\ud83e\uddb8\u200d\u2642\ufe0f Writing Long Pipelines",description:"Extra activity! Do it if you have extra time or are following along at home. It won't be covered during the hands-on lab.",source:"@site/docs/30-simple-queries/6-writing-long-pipelines.mdx",sourceDirName:"30-simple-queries",slug:"/simple-queries/writing-long-pipelines",permalink:"/aggregation-pipeline-lab/docs/simple-queries/writing-long-pipelines",draft:!1,unlisted:!1,editUrl:"https://github.com/mongodb-developer/aggregation-pipeline-lab/blob/main/docs/30-simple-queries/6-writing-long-pipelines.mdx",tags:[],version:"current",sidebarPosition:6,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\ud83d\udc50 Combining stages",permalink:"/aggregation-pipeline-lab/docs/simple-queries/combining-them-all"},next:{title:"\ud83e\uddb8\u200d\u2642\ufe0f Repeating Stages",permalink:"/aggregation-pipeline-lab/docs/simple-queries/repeating-stages"}},c={},d=[];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\ufe0f-writing-long-pipelines",children:"\ud83e\uddb8\u200d\u2642\ufe0f Writing Long Pipelines"})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsx)(n.p,{children:"Extra activity! Do it if you have extra time or are following along at home. It won't be covered during the hands-on lab."})}),"\n",(0,r.jsxs)(n.p,{children:["Aggregation pipelines can get very long, depending on how many stages we need to run. Writing a pipeline is writing code, as you will write it using one of the many MongoDB drivers in your own language. Here we're presenting the examples using JavaScript suitable for the MongoDB shell ",(0,r.jsx)(n.a,{href:"https://www.mongodb.com/docs/mongodb-shell/",children:"mongosh"}),", but if you are writing a microservice in Rust, you'll definitely write your pipelines in Rust."]}),"\n",(0,r.jsx)(n.admonition,{type:"danger",children:(0,r.jsxs)(n.p,{children:["The following syntax doesn't work in the Atlas UI aggregations editor. The editor doesn't support declaring variables. You can try this using the built-in MongoDB Shell in ",(0,r.jsx)(n.a,{href:"https://www.mongodb.com/products/tools/compass",children:"MongoDB Compass"}),"."]})}),"\n",(0,r.jsx)(n.p,{children:"This is why we should rewrite our last pipeline like this:"}),"\n",(0,r.jsxs)(n.p,{children:["Get 15 books from 1985 with less than 150 pages. Show only the ",(0,r.jsx)(n.code,{children:"title"}),", ",(0,r.jsx)(n.code,{children:"year"}),", ",(0,r.jsx)(n.code,{children:"totalInventory"}),", and ",(0,r.jsx)(n.code,{children:"available"})," books (sample doc ",(0,r.jsx)(n.a,{href:"/docs/simple-queries/project",children:"here"}),")."]}),"\n",(0,r.jsx)(a.A,{groupId:"aggregations",children:(0,r.jsxs)(i.A,{value:"mongodb-shell",label:"MongoDB Shell",children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"db.books.aggregate([\n    { $match: {year: 1985, pages: { $lt: 150 } } }, \n    { $project: {_id: 0, title: 1, year: 1, totalInventory: 1, available: 1} }, \n    { $limit: 15 }\n])\n"})}),(0,r.jsx)(n.p,{children:"Will be changed into:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"let lessThan150 = { $lt: 150 };\nlet booksFrom1985With150pages = {$match: {year: 1985, pages: lessThan150 }};\nlet showOnlyTheseFields = {$project: {_id: 0, title: 1, year: 1, totalInventory: 1, available: 1}};\nlet getJust15books =  {$limit: 15};\n\ndb.books.aggregate([\n    booksFrom1985With150pages,\n    showOnlyTheseFields,\n    getJust15books,\n]);\n"})})]})}),"\n",(0,r.jsx)(n.p,{children:"Easier to read and understand, right?"}),"\n",(0,r.jsx)(n.p,{children:"\ud83d\udc50 Try to run the above pipeline and compare your results. They should be the same as before."}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["Write your aggregation pipelines like you'll compose functions in your programming language. Aggregations ",(0,r.jsx)(n.em,{children:"are"})," code that runs on the server. In the client, you just express ",(0,r.jsx)(n.em,{children:"what"})," you want to be done, not ",(0,r.jsx)(n.em,{children:"how"})," to do it."]})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["As this is code, we can even add comments (starting with ",(0,r.jsx)(n.code,{children:"//"}),") to our pipelines. Or write functions that take parameters and return a stage. Or unit test our stages."]})}),"\n",(0,r.jsxs)(n.p,{children:["\ud83d\udc50 We can also use ",(0,r.jsx)(n.code,{children:"$gte"})," to get the books with 150 pages or more. Check $gte syntax in the ",(0,r.jsx)(n.a,{href:"https://www.mongodb.com/docs/manual/reference/operator/query/gte/",children:"docucumentation"})," and write an aggregation pipeline to return 15 books from 1985 with more than 150 pages. Show only the ",(0,r.jsx)(n.code,{children:"title"}),", ",(0,r.jsx)(n.code,{children:"year"}),", ",(0,r.jsx)(n.code,{children:"totalInventory"}),", and ",(0,r.jsx)(n.code,{children:"available"})," books (sample doc ",(0,r.jsx)(n.a,{href:"/docs/simple-queries/project",children:"here"}),")."]}),"\n",(0,r.jsxs)(t,{children:[(0,r.jsx)("summary",{children:"Answer"}),(0,r.jsx)("div",{children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"let moreThan150pages =  {pages: {$gte: 150}}\nlet booksFrom1985WithMoreThan150pages = {$match: {$and: [{year: 1985}, moreThan150pages]}};\nlet showOnlyTheseFields = {$project: {_id: 0, title: 1, year: 1, totalInventory: 1, available: 1}};\nlet getJust15books =  {$limit: 15};\n\ndb.books.aggregate([\n    booksFrom1985WithMoreThan150pages,\n    showOnlyTheseFields,\n    getJust15books,\n]);\n"})})})]})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},9365:(e,n,t)=>{t.d(n,{A:()=>i});t(6540);var r=t(8215);const o={tabItem:"tabItem_Ymn6"};var a=t(4848);function i(e){let{children:n,hidden:t,className:i}=e;return(0,a.jsx)("div",{role:"tabpanel",className:(0,r.A)(o.tabItem,i),hidden:t,children:n})}},1470:(e,n,t)=>{t.d(n,{A:()=>j});var r=t(6540),o=t(8215),a=t(3104),i=t(6347),s=t(205),l=t(7485),u=t(1682),c=t(679);function d(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,r.useMemo)((()=>{const e=n??function(e){return d(e).map((e=>{let{props:{value:n,label:t,attributes:r,default:o}}=e;return{value:n,label:t,attributes:r,default:o}}))}(t);return function(e){const n=(0,u.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function g(e){let{queryString:n=!1,groupId:t}=e;const o=(0,i.W6)(),a=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,l.aZ)(a),(0,r.useCallback)((e=>{if(!a)return;const n=new URLSearchParams(o.location.search);n.set(a,e),o.replace({...o.location,search:n.toString()})}),[a,o])]}function m(e){const{defaultValue:n,queryString:t=!1,groupId:o}=e,a=h(e),[i,l]=(0,r.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const r=t.find((e=>e.default))??t[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:a}))),[u,d]=g({queryString:t,groupId:o}),[m,b]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[o,a]=(0,c.Dv)(t);return[o,(0,r.useCallback)((e=>{t&&a.set(e)}),[t,a])]}({groupId:o}),f=(()=>{const e=u??m;return p({value:e,tabValues:a})?e:null})();(0,s.A)((()=>{f&&l(f)}),[f]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!p({value:e,tabValues:a}))throw new Error(`Can't select invalid tab value=${e}`);l(e),d(e),b(e)}),[d,b,a]),tabValues:a}}var b=t(2303);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=t(4848);function y(e){let{className:n,block:t,selectedValue:r,selectValue:i,tabValues:s}=e;const l=[],{blockElementScrollPositionUntilNextRender:u}=(0,a.a_)(),c=e=>{const n=e.currentTarget,t=l.indexOf(n),o=s[t].value;o!==r&&(u(n),i(o))},d=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const t=l.indexOf(e.currentTarget)+1;n=l[t]??l[0];break}case"ArrowLeft":{const t=l.indexOf(e.currentTarget)-1;n=l[t]??l[l.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":t},n),children:s.map((e=>{let{value:n,label:t,attributes:a}=e;return(0,x.jsx)("li",{role:"tab",tabIndex:r===n?0:-1,"aria-selected":r===n,ref:e=>l.push(e),onKeyDown:d,onClick:c,...a,className:(0,o.A)("tabs__item",f.tabItem,a?.className,{"tabs__item--active":r===n}),children:t??n},n)}))})}function w(e){let{lazy:n,children:t,selectedValue:a}=e;const i=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=i.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:(0,o.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:i.map(((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==a})))})}function v(e){const n=m(e);return(0,x.jsxs)("div",{className:(0,o.A)("tabs-container",f.tabList),children:[(0,x.jsx)(y,{...n,...e}),(0,x.jsx)(w,{...n,...e})]})}function j(e){const n=(0,b.A)();return(0,x.jsx)(v,{...e,children:d(e.children)},String(n))}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>s});var r=t(6540);const o={},a=r.createContext(o);function i(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);